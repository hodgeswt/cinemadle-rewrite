name: Build Containers
on:
  push:
    branches:
      - 'main'
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: 'Rebuild all components (ignores change detection)'
        required: false
        default: false
        type: boolean

concurrency:
  group: BuildContainers
  cancel-in-progress: true
jobs:
  determine-components:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      has_components: ${{ steps.generate-matrix.outputs.has_components }}
      build_tag: ${{ steps.determine-build-tag.outputs.build_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect component changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: none
          filters: |
            backend:
              - 'backend-dotnet/**'
              - 'backend-unittest/**'
              - 'devops/backend/**'
            frontend:
              - 'frontend/**'
              - 'devops/frontend/**'

      - name: Build matrix payload
        id: generate-matrix
        run: |
          python <<'PY'
          import json
          import os

          components = []
          added = set()

          def add(component, image, repository):
              if component in added:
                  return
              added.add(component)
              components.append({
                  'component': component,
                  'image': image,
                  'repository': repository,
              })

          # Check if rebuild_all is enabled or if specific components changed
          rebuild_all = os.environ.get('REBUILD_ALL', 'false').lower() == 'true'
          
          if rebuild_all or os.environ.get('BACKEND') == 'true':
              add('backend', 'cinemadle', 'hodgeswt/cinemadle')

          if rebuild_all or os.environ.get('FRONTEND') == 'true':
              add('frontend', 'cinemadle-frontend', 'hodgeswt/cinemadle-frontend')

          matrix = {'include': components}
          has_components = 'true' if components else 'false'

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"matrix={json.dumps(matrix)}\n")
              fh.write(f"has_components={has_components}\n")
          PY
        env:
          BACKEND: ${{ steps.filter.outputs.backend }}
          FRONTEND: ${{ steps.filter.outputs.frontend }}
          REBUILD_ALL: ${{ github.event.inputs.rebuild_all }}

      - name: Determine build tag
        id: determine-build-tag
        run: |
          # add 85 because previous builds were done outside of GitHub Actions
          echo "build_tag=$((GITHUB_RUN_NUMBER + 85))" >> $GITHUB_OUTPUT

  Build:
    needs: determine-components
    if: ${{ needs.determine-components.outputs.has_components == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine-components.outputs.matrix) }}
    env:
      BUILD_TAG: ${{ needs.determine-components.outputs.build_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Up Dotnet
        if: ${{ matrix.component == 'backend' }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.117

      - name: Run Unit Tests
        if: ${{ matrix.component == 'backend' }}
        working-directory: backend-unittest
        run: |
          dotnet test

      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.component }} image
        shell: pwsh
        env:
          VITE_API_ENDPOINT: ${{ secrets.VITE_API_ENDPOINT }}
          VITE_STRIPE_FRONTEND_KEY: ${{ secrets.VITE_STRIPE_FRONTEND_KEY }}
          VITE_PRODUCT_IDS: ${{ secrets.VITE_PRODUCT_IDS }}
          CINEMADLE_ADMIN_EMAIL: ${{ secrets.CINEMADLE_ADMIN_EMAIL }}
          CINEMADLE_TEST_MODE: 'false'
        run: |
          $buildArgs = @{
            VITE_API_ENDPOINT      = $env:VITE_API_ENDPOINT
            VITE_STRIPE_FRONTEND_KEY = $env:VITE_STRIPE_FRONTEND_KEY
            VITE_PRODUCT_IDS       = $env:VITE_PRODUCT_IDS
            CINEMADLE_ADMIN_EMAIL  = $env:CINEMADLE_ADMIN_EMAIL
            CINEMADLE_TEST_MODE    = $env:CINEMADLE_TEST_MODE
          }

          ./devops/build.ps1 -Tag $env:BUILD_TAG -Component '${{ matrix.component }}' -BuildArgs $buildArgs

      - name: Tag and push ${{ matrix.repository }}
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          docker tag ${{ matrix.image }}:${{ env.BUILD_TAG }} ${{ matrix.repository }}:${{ env.BUILD_TAG }}
          docker tag ${{ matrix.image }}:${{ env.BUILD_TAG }} ${{ matrix.repository }}:latest
          docker push ${{ matrix.repository }}:${{ env.BUILD_TAG }}
          docker push ${{ matrix.repository }}:latest
